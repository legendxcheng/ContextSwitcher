# 弹出式任务切换器开发计划

**项目**: ContextSwitcher - 弹出式任务切换器功能  
**版本**: v2.0 新特性  
**预计时间**: 2-3天 (12-17小时)  
**创建日期**: 2025年7月7日  
**设计理念**: 解决快捷键冲突，提供现代化的任务切换体验

---

## 📋 功能概述

### 核心特性
- **触发方式**: 单一全局热键 `Ctrl+Alt+Space`（避免数字键冲突）
- **显示位置**: 鼠标所在屏幕中央的大尺寸弹出窗口
- **窗口规格**: 800x700像素，TopMost置顶显示
- **交互方式**: 键盘方向键/鼠标滚轮选择，回车确认，2秒自动超时
- **视觉设计**: 大字体、清晰布局，显示任务详细信息

### 解决的问题
1. **快捷键冲突**: 避免 `Ctrl+Alt+1-9` 与常见应用的冲突
2. **可视化选择**: 提供直观的任务列表，而非盲选
3. **信息丰富**: 显示任务状态、窗口数量、最后访问时间等详细信息
4. **现代化体验**: 类似 Alt+Tab 的现代任务切换器体验

---

## 🛠 技术架构

### 新增文件结构
```
gui/
├── task_switcher_dialog.py     # 主切换器对话框类
utils/
├── screen_helper.py            # 屏幕位置和鼠标检测工具
core/
├── hotkey_manager.py           # 扩展：添加切换器热键支持
config/
├── config.json                 # 扩展：添加切换器配置选项
```

### 依赖组件
- **现有依赖**: FreeSimpleGUI, pywin32, pynput (无新增依赖)
- **复用组件**: TaskManager, WindowManager, ModernUIConfig
- **新增工具**: ScreenHelper (鼠标位置检测)

---

## 📅 详细开发计划

### **阶段1: 基础架构和窗口框架** ⏱️ 2-3小时

#### 1.1 创建核心模块文件
- [ ] 创建 `gui/task_switcher_dialog.py`
  - 定义 `TaskSwitcherDialog` 主类
  - 设置800x700窗口配置
  - 集成现代化UI主题
- [ ] 创建 `utils/screen_helper.py`
  - 实现鼠标位置检测功能
  - 添加多屏幕支持逻辑
  - 计算最佳窗口显示位置

#### 1.2 实现屏幕位置检测
- [ ] `get_cursor_position()` - 使用 `win32gui.GetCursorPos()`
- [ ] `get_screen_metrics()` - 获取屏幕尺寸信息
- [ ] `calculate_optimal_position()` - 智能计算窗口位置
- [ ] 添加边界检查，确保窗口完全可见

#### 1.3 创建基础窗口框架
- [ ] 配置TopMost属性和模态窗口
- [ ] 应用现代化主题和图标
- [ ] 实现基础的显示/隐藏方法
- [ ] 添加窗口关闭和资源清理逻辑

### **阶段2: 任务列表UI和视觉设计** ⏱️ 3-4小时

#### 2.1 设计大界面字体系统
- [ ] 定义切换器专用字体配置
  ```python
  SWITCHER_FONTS = {
      'task_title': ('Segoe UI', 16, 'bold'),    # 任务名称
      'task_info': ('Segoe UI', 12),             # 任务详情
      'hotkey': ('Segoe UI', 14, 'bold'),        # 快捷键编号
      'status': ('Segoe UI', 10, 'bold'),        # 状态信息
      'timestamp': ('Segoe UI', 9),              # 时间戳
  }
  ```

#### 2.2 实现任务列表显示
- [ ] 创建9个任务槽位的垂直布局
- [ ] 每行显示：`[编号] 任务名称 | 状态 | 窗口数 | 最后访问`
- [ ] 集成任务状态图标和颜色编码
- [ ] 处理空任务槽位的占位显示

#### 2.3 实现选中状态视觉效果
- [ ] 设计选中任务的高亮样式
  ```python
  selected_style = {
      'background': '#0078D4',    # Windows蓝
      'text': '#FFFFFF',          # 白色文字
      'border': '2px solid #106EBE'
  }
  ```
- [ ] 添加选中指示器（左侧箭头或边框）
- [ ] 实现选中状态的平滑切换

### **阶段3: 交互控制和用户输入** ⏱️ 2-3小时

#### 3.1 实现键盘导航
- [ ] 处理上下方向键 (`Up:38`, `Down:40`)
- [ ] 实现回车键确认选择 (`Return:13`)
- [ ] 添加ESC键取消功能 (`Escape:27`)
- [ ] 支持数字键1-9快速选择
- [ ] 添加键盘事件的防抖处理

#### 3.2 实现鼠标交互
- [ ] 处理鼠标点击选择任务
- [ ] 实现鼠标滚轮上下切换
- [ ] 添加鼠标悬停高亮效果
- [ ] 支持双击立即切换任务

#### 3.3 添加交互反馈
- [ ] 实现选中状态的即时更新
- [ ] 优化响应速度（目标<50ms）
- [ ] 添加操作音效反馈（可配置）

### **阶段4: 自动超时和任务切换逻辑** ⏱️ 2小时

#### 4.1 实现自动超时机制
- [ ] 创建2秒倒计时定时器
  ```python
  self.auto_close_timer = threading.Timer(2.0, self.execute_selection)
  ```
- [ ] 在用户操作时重置定时器
- [ ] 实现超时后的自动任务切换
- [ ] 添加可选的倒计时进度指示器

#### 4.2 集成任务切换逻辑
- [ ] 调用现有的 `TaskManager.switch_to_task(index)`
- [ ] 处理切换成功/失败的用户反馈
- [ ] 实现切换后的窗口自动关闭
- [ ] 添加切换操作的日志记录

### **阶段5: 热键集成和主程序整合** ⏱️ 1-2小时

#### 5.1 扩展热键管理器
- [ ] 在 `HotkeyManager` 中添加切换器热键
- [ ] 配置 `Ctrl+Alt+Space` 为默认触发键
- [ ] 实现与现有热键系统的兼容性
- [ ] 添加热键启用/禁用控制选项

#### 5.2 整合到主程序
- [ ] 在 `main.py` 中初始化切换器组件
- [ ] 连接热键事件和切换器显示逻辑
- [ ] 确保与现有主窗口功能的无冲突运行
- [ ] 添加启动时的组件初始化

### **阶段6: 错误处理和边界情况** ⏱️ 1小时

#### 6.1 实现错误处理
- [ ] 处理无任务时的空状态显示
- [ ] 处理任务切换失败的降级方案
- [ ] 添加屏幕边界检查和位置调整
- [ ] 实现异常情况的优雅错误提示

#### 6.2 优化边界情况
- [ ] 防止快速连续热键触发导致的重复窗口
- [ ] 确保窗口焦点管理的正确性
- [ ] 处理系统锁屏、屏保等特殊状态
- [ ] 添加内存泄漏防护和资源清理

### **阶段7: 配置选项和用户自定义** ⏱️ 1小时

#### 7.1 添加配置选项
- [ ] 在 `config.json` 中添加切换器配置段
  ```json
  "task_switcher": {
      "enabled": true,
      "hotkey": ["ctrl", "alt", "space"],
      "window_size": [800, 700],
      "auto_close_delay": 2.0,
      "show_hotkey_hints": true
  }
  ```

#### 7.2 集成到设置界面
- [ ] 在设置对话框中添加切换器配置页面
- [ ] 提供热键自定义和冲突检测
- [ ] 添加切换器功能的启用/禁用开关
- [ ] 实现配置更改的实时生效

### **阶段8: 测试和性能优化** ⏱️ 1-2小时

#### 8.1 功能测试
- [ ] 测试所有键盘和鼠标交互响应
- [ ] 验证多屏幕环境下的正确显示
- [ ] 测试不同任务数量（0-9个）的表现
- [ ] 验证热键冲突检测和处理

#### 8.2 性能优化
- [ ] 优化窗口显示速度（目标<100ms）
- [ ] 减少内存占用和CPU使用率
- [ ] 优化任务列表的刷新频率
- [ ] 确保长时间运行的稳定性

#### 8.3 最终集成测试
- [ ] 与现有所有功能的兼容性测试
- [ ] 用户体验流程测试和优化
- [ ] 代码质量审查和文档完善
- [ ] 准备用户使用说明文档

---

## 🎯 里程碑和交付物

### 里程碑1: 基础窗口框架 (完成阶段1-2)
**交付物**: 可显示的大尺寸任务列表窗口
**验收标准**: 窗口能在屏幕中央正确显示，任务信息清晰可读

### 里程碑2: 完整交互功能 (完成阶段3-4)  
**交付物**: 支持所有用户交互的功能完整版本
**验收标准**: 键盘鼠标操作正常，自动超时切换工作

### 里程碑3: 系统集成版本 (完成阶段5-6)
**交付物**: 集成到主程序的稳定版本
**验收标准**: 热键触发正常，与现有功能无冲突

### 里程碑4: 生产就绪版本 (完成阶段7-8)
**交付物**: 包含配置选项的完整版本
**验收标准**: 所有测试通过，性能指标达标

---

## ⚠️ 风险评估和缓解策略

### 中等风险
- **多屏幕位置计算复杂性**
  - 缓解: 先实现单屏支持，后续扩展多屏
  - 备选方案: 固定显示在主屏幕中央

### 低风险
- **热键系统扩展兼容性**
  - 缓解: 复用现有热键架构，最小化修改
- **大窗口性能和响应速度**
  - 缓解: 使用轻量级组件，避免复杂渲染

---

## 📊 成功指标

### 性能指标
- 窗口显示速度: <100ms
- 交互响应时间: <50ms
- 内存占用增量: <50MB
- CPU占用率: <2%

### 用户体验指标
- 热键冲突解决: 100%兼容常见开发工具
- 可视化改进: 信息展示清晰度提升80%
- 操作效率: 任务切换操作步骤减少50%

### 技术指标
- 代码覆盖率: >80%
- 错误处理覆盖: 100%关键路径
- 多屏幕兼容: 支持2-4屏配置
- 系统兼容: Windows 10/11完全支持

---

## 📝 开发注意事项

1. **保持向后兼容**: 确保现有热键功能继续可用
2. **模块化设计**: 切换器应当作独立功能模块，便于开关
3. **性能优先**: 大窗口设计不应影响整体应用性能
4. **用户体验**: 提供平滑的过渡动画和清晰的视觉反馈
5. **错误恢复**: 任何异常都不应影响主程序稳定性

---

**总预计工时**: 12-17小时  
**推荐开发顺序**: 严格按阶段1→8顺序执行，确保每个里程碑验收通过后再进入下一阶段