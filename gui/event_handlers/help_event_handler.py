"""
å¸®åŠ©äº‹ä»¶å¤„ç†å™¨

å¤„ç†å¸®åŠ©ä¿¡æ¯çš„æ˜¾ç¤º
"""

from typing import Dict, Any

from gui.event_handlers.base_handler import BaseEventHandler
from gui.interfaces.event_interfaces import IWindowActions
from utils.popup_helper import PopupManager


class HelpEventHandler(BaseEventHandler):
    """å¸®åŠ©äº‹ä»¶å¤„ç†å™¨

    å¤„ç†å¸®åŠ©æŒ‰é’®ç‚¹å‡»ï¼Œæ˜¾ç¤ºä½¿ç”¨æŒ‡å—å’Œå¿«æ·é”®è¯´æ˜
    """

    def __init__(self, task_manager, window_actions: IWindowActions, data_provider=None):
        """åˆå§‹åŒ–å¸®åŠ©äº‹ä»¶å¤„ç†å™¨

        Args:
            task_manager: ä»»åŠ¡ç®¡ç†å™¨å®ä¾‹
            window_actions: çª—å£åŠ¨ä½œæ¥å£å®ç°
            data_provider: æ•°æ®æä¾›å™¨ï¼ˆå¯é€‰ï¼‰
        """
        super().__init__(task_manager, window_actions, data_provider)
        self.popup_manager = PopupManager(window_actions.get_window())

        # äº‹ä»¶è·¯ç”±æ˜ å°„
        self.event_handlers = {
            "-HELP-": self._handle_help,
        }

    def handle_event(self, event: str, values: Dict[str, Any]) -> bool:
        """å¤„ç†å¸®åŠ©ç›¸å…³äº‹ä»¶"""
        handler = self.event_handlers.get(event)
        if handler:
            handler()
            return True
        return False

    def _handle_help(self):
        """æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"""
        try:
            from utils.config import get_config
            config = get_config()

            # è·å–å½“å‰å¿«æ·é”®é…ç½®
            hotkey_config = config.get_hotkeys_config()
            modifiers = hotkey_config.get('switcher_modifiers', ['ctrl', 'alt'])
            key = hotkey_config.get('switcher_key', 'space')

            # æ ¼å¼åŒ–å¿«æ·é”®æ˜¾ç¤º
            mod_display = '+'.join([m.title() for m in modifiers])
            key_display = key.title() if key else "Space"
            hotkey_display = f"{mod_display}+{key_display}"

            help_text = f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       ContextSwitcher æ“ä½œæŒ‡å—
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ¨ å¿«æ·é”®                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {hotkey_display:<36} â”‚ å¿«é€Ÿåˆ‡æ¢ä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–± é¼ æ ‡æ“ä½œ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒå‡»ä»»åŠ¡  â†’ åˆ‡æ¢åˆ°è¯¥ä»»åŠ¡çš„çª—å£          â”‚
â”‚ å•å‡»ä»»åŠ¡  â†’ é€‰ä¸­ä»»åŠ¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ› æŒ‰é’®è¯´æ˜                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ï¼‹  æ·»åŠ æ–°ä»»åŠ¡    âœ  ç¼–è¾‘é€‰ä¸­ä»»åŠ¡      â”‚
â”‚ âœ•  åˆ é™¤é€‰ä¸­ä»»åŠ¡  ğŸ…  ç•ªèŒ„é’Ÿä¸“æ³¨        â”‚
â”‚ ğŸ“Š  æŸ¥çœ‹ç»Ÿè®¡     âš™  æ‰“å¼€è®¾ç½®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ æç¤º: å¯åœ¨è®¾ç½®ä¸­è‡ªå®šä¹‰å¿«æ·é”®å’Œå€’è®¡æ—¶
ğŸ’¡ æ”¯æŒ: ä¸€ä¸ªä»»åŠ¡ç»‘å®šå¤šä¸ªçª—å£
ğŸ’¡ æ™ºèƒ½: Explorerçª—å£è‡ªåŠ¨è®°ä½è·¯å¾„"""

            self.popup_manager.show_message(help_text, "å¸®åŠ©")

        except Exception as e:
            print(f"æ˜¾ç¤ºå¸®åŠ©å¤±è´¥: {e}")
            self.set_status("å¸®åŠ©åŠ è½½å¤±è´¥", 3000)
